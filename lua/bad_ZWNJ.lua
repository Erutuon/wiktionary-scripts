local data_by_title = require "data_by_title" "templates"
local iterate_templates = require "iterate_templates"
local rure = require "luarure"
local Array = require "mediawiki.array"

local chars_from_names = require "utils".chars_from_names

local ZWNJ = chars_from_names("zero width non-joiner")

local iter_prev_char
do
	local max_UTF8_bytes = 4
	function iter_prev_char(str, pos)
		return coroutine.wrap(function ()
			pos = pos - 1
			while pos >= 1 do
				local char = str:sub(math.max(pos - max_UTF8_bytes, 0), pos):match(utf8.charpattern .. "$")
				if char == "" then
					break
				end
				pos = pos - #char + 1
				coroutine.yield(char)
			end
		end)
	end
end

local function iter_next_char(str, pos)
	return coroutine.wrap(function ()
		while true do
			local char
			char, pos = str:match("^(" .. utf8.charpattern .. ")()", pos)
			if not char then
				break
			end
			coroutine.yield(char)
		end
	end)
end

local next_bad_ZWNJ
do
	-- Rules based on https://www.unicode.org/reports/tr31/tr31-31.html#A1
	
	-- Regex generated by https://unicode.org/cldr/utility/list-unicodeset.jsp
	-- with C-style escapes converted to Rust-style escapes.
	-- [[\p{Joining_Type=Dual_Joining}\p{Joining_Type=Left_Joining}]&\p{Script=Arabic}]
	local Arabic_left_joining = rure.new "[Ø¦à¢¨à¢©Ù®Ø¨Ù»Ù¾Ú€İ-İ•à¢ İ–à¢¡à¢¶à¢·ØªØ«Ù¹ÙºÙ¼Ù½Ù¿à¢¸Ø¬ÚƒÚ„Ú†Ú¿Ú‡à¢¢Ø­Ø®ÚÚ‚Ú…İ—İ˜İ®İ¯İ²İ¼Ø³Ø´Úš-ÚœÛºİœİ­İ°İ½İ¾ØµØ¶Úà¢¯ÚÛ»Ø·Ø¸ÚŸà¢£Ø¹ØºÚ Û¼İ-İŸà¢³ÙÚ¡Ú¢à¢»Ú£Ú¤à¢¤Ú¥Ú¦İ İ¡Ù¯Ù‚Ú§à¢¼Ú¨à¢¥ÙƒÚ©-Ú¬İ¿Ú­Ú®à¢´Ú¯à¢°Ú°-Ú´İ¢Ø»Ø¼İ£İ¤Ù„Úµ-Ú¸İªà¢¦Ù…İ¥İ¦à¢§Ù†Úºà¢½Ú»-Ú½Ú¹İ§-İ©Ù‡Ú¾ÛÛ‚Û¿Ù‰ÙŠÙ¸ÛŒÛÛÛ‘Ø½-Ø¿Ø İµ-İ·à¢ºİºİ»]"
	
	-- [[\p{Joining_Type=Dual_Joining}\p{Joining_Type=Right_Joining}]&\p{Script=Arabic}]
	local Arabic_right_joining = rure.new "[Ø¢Ø£Ù²Ù±Ø¤Ø¥Ù³İ³İ´Ø¦à¢¨à¢©à¢¬Ø§ÙµÙ®Ø¨Ù»Ù¾Ú€İ-İ•à¢ İ–à¢¡à¢¶à¢·Ø©-Ø«Ù¹ÙºÙ¼Ù½Ù¿à¢¸Ø¬ÚƒÚ„Ú†Ú¿Ú‡à¢¢Ø­Ø®ÚÚ‚Ú…İ—İ˜İ®İ¯İ²İ¼Ø¯Ø°Úˆ-Úà¢®Ú-ÚÛ®İ™İšØ±Ø²Ú‘-Ú™Û¯İ›İ«İ¬İ±à¢ªà¢²à¢¹Ø³Ø´Úš-ÚœÛºİœİ­İ°İ½İ¾ØµØ¶Úà¢¯ÚÛ»Ø·Ø¸ÚŸà¢£Ø¹ØºÚ Û¼İ-İŸà¢³ÙÚ¡Ú¢à¢»Ú£Ú¤à¢¤Ú¥Ú¦İ İ¡Ù¯Ù‚Ú§à¢¼Ú¨à¢¥ÙƒÚ©-Ú¬İ¿Ú­Ú®à¢´Ú¯à¢°Ú°-Ú´İ¢Ø»Ø¼İ£İ¤Ù„Úµ-Ú¸İªà¢¦Ù…İ¥İ¦à¢§Ù†Úºà¢½Ú»-Ú½Ú¹İ§-İ©Ù‡Ú¾Û-ÛƒÛ¿Û•Û€ÙˆÙ¶Û„-Û‡Ù·Ûˆ-Û‹à¢±Ûİ¸İ¹à¢«Ù‰ÙŠÙ¸ÛŒ-ÛÛÛ‘Ø½-Ø¿Ø İµ-İ·à¢ºÛ’Û“İºİ»]"
	
	-- \p{Joining_Type=Transparent}
	local transparent = rure.new "[\u{00AD}\u{034F}ÒˆÒ‰Ö‘-Ö¯Ö½×„×…Ø-Øš\u{061C}Û–-ÛœÛŸ-Û¤Û§Û¨Ûª-Û­\u{070F}İ€İƒİ„İ‡-İŠà£“-à£¡à£ª-à£¯à£³à¥‘à¥’à¼˜à¼™à¼µà¼·à¾‚à¾ƒà¾†à¾‡à¿†\u{17B4}\u{17B5}áŸ“\u{180B}-\u{180D}á©¿á­«-á­³á³-á³’á³”-á³ á³¢-á³¨á³´á³¸á³¹\u{200B}\u{200E}\u{200F}\u{202A}-\u{202E}\u{2060}-\u{2064}\u{206A}-\u{206F}âµ¿ê™°-ê™²ê£ -ê£±\u{FE00}-ï¸ï¸¡ï¸£-ï¸¦ï¸¨ï¸ª-ï¸­ï¸¯\u{FEFF}\u{FFF9}-\u{FFFB}ğ‹ ğ‘¦-ğ‘¬ğ‘°-ğ‘´\u{13430}-\u{13438}\u{1BCA0}-\u{1BCA3}ğ…§-ğ…©\u{1D173}-ğ†‚ğ†…-ğ†‹ğ†ª-ğ†­ğ‰‚-ğ‰„ğ¨€-ğ¨¶ğ¨»-ğ©¬ğ©µğª„ğª›-ğªŸğª¡-ğª¯ğ£-ğ£–\u{E0001}\u{E0020}-\u{E007F}\u{E0100}-\u{E01EF}Ì²Ì“ÍƒÒ†â³±Ì”Ò…â³°ÌÍà¥”Ì€Í€à¥“Ì†Ì‚ÌŒÌŠÍ‚ÌˆÍ„Ì‹ÌƒÌ‡Ì¸Ì§Ì¨Ì„ÌÌÌ’Ì•ÌšÌ½-Ì¿Í†ÍŠ-ÍŒÍ-Í’Í—Í›ÍÍÒ„Ò‡İİ…áŸ‹-áŸ‘áŸáª°-áª´áª»áª¼á·€á·á·ƒ-á·‰á·‹-á·á·‘á·µ-á·¸á·»á·¾âƒ°â³¯ê™¼ê™½ğ«¥ğ´¤-ğ´§ğ½ˆ-ğ½Šğ½Œğ›²Ì–-Ì™Ìœ-Ì Ì©-Ì¬Ì¯Ì³Ìº-Ì¼Í‡-Í‰ÍÍÍ“-Í–Í™ÍšÍœÍŸÍ¢İ‚İ†ß½à¡™-à¡›áªµ-áªºáª½á·‚á·á·á·¹á·¼á·½á·¿âƒ¬-âƒ¯ï¸§ğ¨ğ«¦ğ½†ğ½‡ğ½‹ğ½-ğ½Ì¶Ì·âƒ˜-âƒšâƒ¥âƒªâƒ«ğ›²áª¾âƒ-âƒ âƒ¢-âƒ¤ã‚™ã‚šÌµÌ…Ì‰Ì-Ì‘Ì›Ì¡-Ì¦Ì­Ì®Ì°Ì±Ì´Ì¹Í…Í˜Í ï¸¢ï¸©Í¡ï¸ Òƒï¸®ê™¯Ö°-Ö¸×‡Ö¹-Ö»×‚×Ö¼Ö¿ï¬à œ-à £à ¥-à §à ©-à ¬à ˜à ™à ­Ù‹à£°à£§ÙŒà£±à£¨Ùà£²à£©Ùà£¤à£´à£µÙà£¥à£¾Ùà£¦à£¶Ù‘à«»ğ‘ˆ·Ù’à«ºğ‘ˆ¾Ù“à«¼Ù”Ù•ÙŸÙ–-Ù˜à£¿Ù™-Ùà££à£·à£¸à£½à£»à£¼à£¹à£ºÙ°Ü‘Ü°-Ü¿ß«-ß³áŸááê›°ê›±ğ–«°-ğ–«´ğ¥„-ğ¥†ğ¥Šğ¥‡-ğ¥‰à¤¼à¦¼à¨¼àª¼à«½-à«¿à¬¼à²¼á¬´á¯¦á°·ê¦³ğ‘‚ºğ‘…³ğ‘‡Šğ‘ˆ¶ğ‘‹©ğ‘Œ»ğ‘Œ¼ğ‘‘†ğ‘“ƒğ‘—€ğ‘š·ğ‘ ºğ‘¨³ğ‘µ‚à¤€à¤à¦à¨àªà¬à°€à²à´á¬€á¬ê£…ê¦€ğ‘‚€ğ‘„€ğ‘†€ğ‘Œğ‘‘ƒğ‘’¿ğ‘–¼ğ‘™€ğ‘¨µ-ğ‘¨·ğ‘°¼ğ‘²¶ğ‘µƒà¤‚à¨‚àª‚à®‚à°„à´€à½¾á€¶áŸ†á©´á¬‚á®€á³­ê ‹ê¦ğ¨ğ‘€ğ‘‚ğ‘„ğ‘†ğ‘ˆ´ğ‘‹Ÿğ‘Œ€ğ‘‘„ğ‘“€ğ‘–½ğ‘˜½ğ‘š«ğ‘ ·ğ‘¨¸ğ‘ª–ğ‘°½ğ‘²µğ‘µ€ğ‘¶•ğ¨ğ‘„‚ğ‘µà§¾ğ‘‡‰ğ‘‘à©°à©±á¬ƒê¦‚á®ğ¨¸-ğ¨ºğ‘‡‹ğ‘‡Œğ‘ª˜à¹à¹‡-à¹à»ˆ-à»êª¿ê«à¼¹ê¤«-ê¤­á€·áŸ‰áŸŠá©µ-á©¼á¤¹-á¤»ğ–¬°ğ„±ğ–¬±ğ„¶ğ–¬²ğ„²ğ–¬³ğ„³ğ–¬´ğ„°ğ–¬µğ„´ğ–¬¶ğ„µğ‹¬-ğ‹¯ã€ª-ã€­âƒ-âƒ—âƒ›âƒœâƒ¡âƒ¦-âƒ©ğ‡½Í£á·²á·“-á·–á·§-á·©Í¨á·—Í©á·™á·˜Í¤á·ªá·«á·šá·›ÍªÍ¥á·œ-á·á·¬Í«á·Ÿ-á·¡Í¦á·³á·­á·®Í¬á·Šá·¢-á·¥á·¯Í­Í§á·´á·°Í®á·±Í¯á·¦á·’â·¶â· -â·£â··ê™´â·¤â·¥ê™µê™¶â·¸â·¦-â·­â·µâ·®ê™·â·¹êšâ·¯ê™»â·°-â·³ê™¸-ê™ºâ·º-â·¼êšŸâ·½-â·¿â·´ğ€€-ğ€†ğ€ˆ-ğ€˜ğ€›-ğ€¡ğ€£ğ€¤ğ€¦-ğ€ªğ¶-ğºà –à —à ›Ş¦-Ş°à¤ºà¥–à¥—à¥-à¥„à¥¢à¥£à¥…à¥•à¥†-à¥ˆê£¿à¥à§-à§„à§¢à§£à§à©‘à©µà©à©‚à©‡à©ˆà©‹-à©à«-à«„à«¢à«£à«…à«‡à«ˆà«à¬¿à­-à­„à­¢à­£à­à­–à¯€à¯à°¾-à±€à±¢à±£à±†-à±ˆà±Š-à±à±•à±–à²¿à³¢à³£à³†à³Œà³àµ-àµ„àµ¢àµ£àµà´»à´¼à·’-à·”à·–à·Šê¯¥ê¯¨ê«¬ê«­ê¯­ê«¶ê ‚ê †ê ¥ê ¦ê£„ğ‘‚³-ğ‘‚¶ğ‘‚¹ğ‘†¶-ğ‘†¾ğ‘ˆ¯-ğ‘ˆ±ğ‘‹£-ğ‘‹¨ğ‘‹ªğ‘€ğ‘¸-ğ‘¿ğ‘‘‚ğ‘’³-ğ‘’¸ğ‘’ºğ‘“‚ğ‘–²ğ‘—œğ‘–³ğ‘—ğ‘–´ğ‘–µğ‘–¿ğ‘˜³-ğ‘˜ºğ‘˜¿ğ‘š­ğ‘š°-ğ‘šµğ‘§”-ğ‘§—ğ‘§šğ‘§›ğ‘§ ğ‘ ¯-ğ‘ ¶ğ‘ ¹ğ‘œ¢-ğ‘œ¥ğ‘œ§-ğ‘œ«ğ‘œ-ğ‘œŸğ‘µ‡ğ‘´±-ğ‘´¶ğ‘´ºğ‘´¼ğ‘´½ğ‘´¿ğ‘µ„ğ‘µ…ğ‘¶ğ‘¶‘ğ‘¶—á®¬á®¢á®£á®­á®¤á®¥á®¨á®©á®«ğ‘€¸-ğ‘†ğ‘¿ğ¨-ğ¨ƒğ¨…ğ¨†ğ¨Œğ¨¿ğ‘°°-ğ‘°¶ğ‘°¸-ğ‘°»ğ‘°¿à¸±à¸´-à¸ºàº±àº´-àº¼êª°êª²-êª´êª·êª¸êª¾à¾à¾¹à¾‘-à¾—à¾™-à¾­à¾ºà¾®-à¾±à¾»à¾²à¾¼à¾³-à¾¸à¾-à¾à½±-à½³à¾€à¾à½´-à½½à¾„ğ‘¨»-ğ‘¨¾ğ‘¨-ğ‘¨Šğ‘¨´ğ‘©‡ğ‘©‘-ğ‘©“ğ‘©™ğ‘©šğ‘©”ğ‘©–ğ‘©•ğ‘©›ğ‘ªŠ-ğ‘ªğ‘ª•ğ‘ª‘-ğ‘ª”ğ‘ª™ğ‘²’-ğ‘²§ğ‘²ª-ğ‘²°ğ‘²²ğ‘²³á°¶á°¬-á°³á¤ -á¤¢á¤§á¤¨á¤²áœ’-áœ”áœ²-áœ´á’á“á²á³á¨—á¨˜á¨›ğ‘»³ğ‘»´á¯¨á¯©á¯­á¯¯-á¯±ê¥‡-ê¥‘ê¤¦-ê¤ªá-á á€½á‚‚á€¾á²á€­á±á€®á€³á€¯á³á´á€°á˜á™á€µá‚…á€²á‚á€´ê§¥á‚†á€¹á€ºá‚ê©¼ğ‘„§-ğ‘„«ğ‘„­-ğ‘„´á·-á½áŸ’á©˜-á©›á©«á©–á©œ-á©á©¬á©¢á©¥-á©ªá©³á© ê¨µê¨¶ê¨©-ê¨®ê¨±ê¨²ê©ƒê©Œá¬¶-á¬ºá¬¼á­‚ê¦¼ê¦¶-ê¦¹ê¦½á¢…á¢†á¢©ğ¥‹ğ–½ğ–¾-ğ–¾’]"
	
	function next_bad_ZWNJ(str, pos)
		pos = pos or 1
		return coroutine.wrap(function ()
			while true do
				local next_pos = str:find(ZWNJ, pos)
				if not next_pos then
					break
				end
				
				local found_left_joining, found_right_joining = false, false
				for char in iter_prev_char(str, next_pos) do
					if Arabic_left_joining:is_match(char) then
						found_left_joining = true
						break
					elseif not transparent:is_match(char) then
						break
					end
				end
				
				for char in iter_next_char(str, next_pos + #ZWNJ) do
					if Arabic_right_joining:is_match(char) then
						found_right_joining = true
						break
					elseif not transparent:is_match(char) then
						break
					end
				end
				
				if not (found_left_joining and found_right_joining) then
					coroutine.yield(next_pos)
					goto continue
				end
				
				::continue::
				pos = next_pos + #ZWNJ
			end
		end)
	end
end

local function collect(iter)
	local vals = Array()
	for val in iter do
		vals:insert(val)
	end
	return vals
end

local count = 0
local limit = type((...)) == "string" and tonumber(...) or math.huge

local Arabic_regex = rure.new "\\p{Arabic}"

for link, title, template in iterate_templates.iterate_links(assert(io.read 'a')) do
	if ((link.term and Arabic_regex:is_match(link.term) and next_bad_ZWNJ(link.term)() ~= nil)
			or (link.alt and Arabic_regex:is_match(link.alt) and next_bad_ZWNJ(link.alt)() ~= nil)) then
		data_by_title[title]:insert(template.text)
		
		count = count + 1
		if count > limit then
			break
		end
	end
end